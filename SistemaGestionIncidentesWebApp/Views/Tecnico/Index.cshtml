@model IEnumerable<SistemaGestionIncidentesWebApp.Models.Tecnico>

@{
    Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
    ViewData["Title"] = "Gestión de Técnicos";
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
}

<div class="container-fluid mt-4">
    <h2 class="mb-4 fw-bold text-dark">Gestión de Técnicos</h2>

    <table id="tablaTecnicos" class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Email</th>
                <th>Rol</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

    <script>
        const apiBaseUrl = "https://localhost:7162/api";
        let tabla;

        $(document).ready(function () {
            cargarTabla();
        });

        function cargarTabla() {
            $.get(`${apiBaseUrl}/Tecnico/Listar`, function (data) {
                if ($.fn.DataTable.isDataTable("#tablaTecnicos")) {
                    tabla.destroy();
                }
                $("#tablaTecnicos tbody").empty();
                tabla = $("#tablaTecnicos").DataTable({
                    data: data,
                    columns: [
                        { data: "id" },
                        { data: "nombre" },
                        { data: "correo" },
                        {
                            data: "rol_id",
                            render: function(data) {
                                return data === 4 ? "Técnico" : "Otro";
                            }
                        },
                        {
                            data: null,
                            render: function (row) {
                                return `
                                    <button class='btn btn-warning btn-sm' onclick='editar(${row.id})'>Editar</button>
                                    <button class='btn btn-danger btn-sm' onclick='eliminar(${row.id})'>Eliminar</button>
                                `;
                            }
                        }
                    ]
                });
            }).fail(function(xhr, status, error){
                alert("Error al cargar técnicos: " + error);
            });
        }

        function editar(id) {
            window.location.href = `/Tecnico/Editar/${id}`;
        }

        function eliminar(id) {
            if (confirm("¿Seguro que quieres eliminar este técnico?")) {
                $.ajax({
                    url: `${apiBaseUrl}/Tecnico/Eliminar/${id}`,
                    type: "DELETE",
                    success: function () {
                        cargarTabla();
                    },
                    error: function (xhr, status, error) {
                        alert("Error al eliminar: " + error);
                    }
                });
            }
        }
    </script>
}
